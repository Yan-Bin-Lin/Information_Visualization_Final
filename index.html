<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>105703011 資科四 林彥賓 hw1</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://unpkg.com/d3-simple-slider"></script>
</head>
<body class="bgc">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-0">
                <div style="margin:0px auto;">
                    <div id="canvas"></div>
                    <div id="float"></div>
                    <div id="slider"></div>
                    <div id="show">
                    </div>
                </div>
                <div class="card bgc" style="width: 550px;">
                    <div class="card-body">
                        <h1 class="card-title">各縣市武漢肺炎確診人數</h1>
                        <hr>
                        <h4 class="card-subtitle mb-2 text-muted">說明</h4>
                        <p>拖拉滑條訂會切換月分範圍變化，滑鼠游動到各省圓圈會顯示該縣市當時的確診人數</p>
                        <hr>
                        <p>
                            資料來源:
                            <a href="https://data.gov.tw/dataset/118038">政府資料開放平台</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        .hidden {
            display: none;
        }
        div.tooltip {
            color: orangered;
            background-color: rgba(226, 226, 226, 0.38);
            padding: .5em;
            text-shadow: #f5f5f5 0 1px 0;
            border-radius: 2px;
            opacity: 0.9;
            position: absolute;
        }
        .site {
            stroke-width: .5px;
            stroke: #333;
            fill: #6495ed;
        }
        .bgc {
            background-color: #242424;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        text {
            opacity: 1;
            color: white;
        }
        hr {
            border-top-color: rgba(255, 255, 255, 0.3);
        }
        .text-muted {
            color: #6495ed!important;
        }
    </style>
    <script>
        // 寬高
        const etendues = d3.select("#canvas").node();
        const width = parseInt(window.getComputedStyle(etendues).width);
        const height = width / 1.5;

        // 地圖
        const geo_path = "https://raw.githubusercontent.com/yezongyang/china-geojson/master/china.json";

        // 確診資料
        const data_path = "https://raw.githubusercontent.com/Yan-Bin-Lin/Information_Visualization_Final/master/ChinaData.csv";

        Promise.all([
            d3.json(geo_path),
            d3.csv(data_path),
        ]).then(values => {
            // data
            data = [];

            function merage(l, r, data){
                let row = data[l];
                for(let i = l+1;i < r;i ++){
                    for(let k in data[i]){
                        row[k] = parseInt(row[k]) + parseInt(data[i][k]);
                    }
                }
                return row;
            }

            /*
            data.push(merage(0, 6, values[1]));
            data.push(merage(6, 35, values[1]));
            data.push(merage(35, 66, values[1]));
            data.push(merage(66, 96, values[1]));
            data.push(merage(96, 127, values[1]));
             */
            for(let i = 0;i < 127;i ++) {
                for(let k in values[1][i]){
                    if(k !== "日期"){
                        values[1][i][k] = parseInt(values[1][i][k]);
                    }
                }
            }
            data = values[1];

            // scale
            max = 66953;
            let scale = d3.scalePow()
                    .exponent(0.3)
                    .range([0,30])
                    .domain([0,max]);

            // projection
            let projection = d3.geoMercator()
                .center([115, 40])
                .scale(height)
                .translate([width / 2, height / 2.5]);

            let path = d3.geoPath().projection(projection);

            let geo = values[0].features;

            //畫布
            let svg = d3.select("#canvas")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            //float window
            let win = d3.select("#float").attr('class', 'hidden tooltip');

            //地圖
            svg.selectAll('path')
                .data(geo)
                .enter()
                .append('path')
                .attr('d', path)
                .attr("stroke", "white")//線的顏色
                .attr("fill", "#242424")
                .attr("name", (d) => d.properties.name)
                .attr("fill-opacity", 1);


            // circle
            let sites = svg.selectAll(".site")
                .data(geo);

            // map of circle event
            let displaySites = function (value) {

                svg.selectAll(".site").remove();

                sites.enter().append("circle")
                    .attr("class", "site")
                    .attr('cx', d => {
                        return projection(d.properties.cp)[0]
                    })
                    .attr('cy', d => {
                        return projection(d.properties.cp)[1]
                    })
                    .attr("r", d => {
                        let  sum = 0;
                        for(let i = value[0]; i <= value[1]; i++){
                            if ((d.properties.name in data[i])){
                                sum += data[i][d.properties.name];
                            }
                        }
                        return scale(sum);
                    })
                    .attr("name", d => {
                        return d.properties.name
                    })
                    .on('mousemove', function (d) {

                        d3.select(this).attr("fill-opacity", 0.5);

                        let now_color = this.getAttribute("fill");

                        let mouse = d3.mouse(this).map(function (d) {
                            return parseInt(d);
                        });

                        win.classed('hidden', false)
                            .attr('style', 'left:' + (mouse[0] + 15) +
                                'px; top:' + (mouse[1] - 35) + 'px')
                            .html(this.getAttribute('name') + ':' + parseInt(scale.invert(parseFloat(this.getAttribute('r')))) + '人');
                    })
                    .on('mouseout', function () {
                        d3.select(this).attr("fill-opacity", 1);
                        win.classed('hidden', true);
                    });

                sites.remove();
            };

            displaySites([1,1]);

            // slider
            let slider = d3
                .sliderHorizontal()
                .ticks(5)
                .tickFormat(d3.format(',.0d'))
                .min('1')
                .max('6')
                .step(0.03968253968) // 5 / 126
                .width(width - 50)
                .value([1, 1])
                .on('onchange', value => {
                    displaySites([tickScale(value[0]), tickScale(value[1])]);
                    displayTicksText();
                });

            d3.select("#slider")
                .append('svg')
                .attr("width", width)
                .append('g')
                .attr('transform', 'translate(30,30)')
                .call(slider);

            // ticks scale
            function tickScale(value) {
                return Math.round((value - 1) * 25.2) // 126 / 5
            }

            // ticks text
            let text = d3
                .selectAll('g.parameter-value')
                .append('text')
                .attr("font-size", 10)
                .attr("y", 27)
                .attr("dy", ".71em")
                .attr("transform", "translate(0, -50)")
                .attr("fill", "#6495ed")
                .attr("class", "cus-ticks-value")
                .text("1/26");

            function displayTicksText() {
                d3
                .selectAll('g.parameter-value')
                .each( function(value){
                    d3.select(this)
                        .select("text.cus-ticks-value")
                        .text(data[tickScale(value)]["日期"]);
                });
            }
        });

    </script>
</body>
</html>